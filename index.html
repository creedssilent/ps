<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Absensi (Offline Mode)</title>
    <style>
        body { font-family: sans-serif; background-color: #f0f2f5; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .container { background-color: #fff; padding: 40px; border-radius: 12px; box-shadow: 0 8px 16px rgba(0,0,0,0.1); text-align: center; width: 90%; max-width: 600px; }
        h1 { margin-bottom: 20px; }
        #barcode-input { width: 100%; padding: 15px; font-size: 1.2rem; border: 2px solid #ddd; border-radius: 8px; box-sizing: border-box; text-align: center; }
        #barcode-input:focus { outline: none; border-color: #1877f2; }
        #log-container { margin-top: 20px; text-align: left; max-height: 250px; overflow-y: auto; border: 1px solid #eee; padding: 15px; border-radius: 8px; }
        #absen-log { list-style-type: none; padding: 0; margin: 0; }
        #absen-log li { padding: 10px; border-bottom: 1px solid #f0f0f0; }
        .sukses { color: #28a745; font-weight: bold; }
        .gagal { color: #dc3545; font-weight: bold; }
        .download-btn { background-color: #1877f2; color: white; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; margin-top: 20px; }
        .download-btn:hover { background-color: #166fe5; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Sistem Absensi Barcode</h1>
        <p>Arahkan scan barcode ke kolom di bawah ini. Data tersimpan di browser.</p>
        
        <form id="absen-form">
            <input type="text" id="barcode-input" placeholder="Tunggu Scan..." autofocus>
        </form>

        <div id="log-container">
            <h3>Log Absensi:</h3>
            <ul id="absen-log"></ul>
        </div>

        <button class="download-btn" onclick="downloadCSV()">⬇️ Download Log Absen (CSV)</button>
    </div>

    <script src="siswa.js"></script>

    <script>
        const absenForm = document.getElementById('absen-form');
        const barcodeInput = document.getElementById('barcode-input');
        const absenLog = document.getElementById('absen-log');
        let logData = [];

        // --- Fungsi Utama ---

        function muatLogDariStorage() {
            const dataTersimpan = localStorage.getItem('logAbsen');
            if (dataTersimpan) {
                logData = JSON.parse(dataTersimpan);
                logData.forEach(item => {
                    const pesan = formatPesan(item);
                    tampilkanLogDiUI(pesan, item.status.toLowerCase());
                });
            }
        }
        
        function tampilkanLogDiUI(pesan, tipe) {
            const logItem = document.createElement('li');
            logItem.innerHTML = pesan;
            logItem.className = tipe;
            absenLog.prepend(logItem);
        }

        // --- PERUBAHAN 1: Menyimpan data dalam format terstruktur ---
        function simpanLog(data) {
            logData.push(data);
            localStorage.setItem('logAbsen', JSON.stringify(logData));
        }

        function formatPesan(data) {
             if (data.status === 'Sukses') {
                return `[${data.waktu}] - Absen berhasil: <strong>${data.nama}</strong> (${data.nisn})`;
            } else {
                return `[${data.waktu}] - Gagal: Barcode <strong>${data.nisn}</strong> tidak terdaftar!`;
            }
        }

        absenForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const nisn = barcodeInput.value.trim();
            const now = new Date();
            const tanggal = now.toLocaleDateString('id-ID', { year: 'numeric', month: '2-digit', day: '2-digit' });
            const waktu = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            
            if (nisn) {
                const siswaTerdaftar = DAFTAR_SISWA.find(siswa => siswa.nisn === nisn);
                
                let dataLog;
                if (siswaTerdaftar) {
                    dataLog = {
                        tanggal: tanggal,
                        waktu: waktu,
                        status: 'Sukses',
                        nama: siswaTerdaftar.nama,
                        nisn: siswaTerdaftar.nisn,
                        kelas: siswaTerdaftar.kelas || '-'
                    };
                } else {
                    dataLog = {
                        tanggal: tanggal,
                        waktu: waktu,
                        status: 'Gagal',
                        nama: 'Tidak Dikenal',
                        nisn: nisn,
                        kelas: '-'
                    };
                }
                const pesan = formatPesan(dataLog);
                tampilkanLogDiUI(pesan, dataLog.status.toLowerCase());
                simpanLog(dataLog);
            }
            
            barcodeInput.value = '';
        });

        // --- PERUBAHAN 2: Fungsi download CSV yang sudah diperbaiki ---
        function downloadCSV() {
            if (logData.length === 0) {
                alert("Belum ada data absensi untuk di-download.");
                return;
            }

            // Membuat header untuk kolom-kolom di Excel
            const header = ["Tanggal", "Waktu", "Status", "Nama", "NISN", "Kelas"];
            let csvContent = header.join(",") + "\n";

            // Mengisi baris data
            logData.forEach(item => {
                const row = [item.tanggal, item.waktu, item.status, item.nama, item.nisn, item.kelas];
                csvContent += row.join(",") + "\n";
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            const namaFile = `log_absen_${new Date().toISOString().slice(0,10)}.csv`;
            link.setAttribute("download", namaFile);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        barcodeInput.addEventListener('blur', () => this.focus());
        window.addEventListener('DOMContentLoaded', muatLogDariStorage);
    </script>
</body>
</html>
